# ほうじ茶（Houjicha）

```
        ＿＿＿
      ／ほうじ＼
     |  ◕ ◕  |    「法的三段論法を、もっと楽しく！」
      ＼  ▽  ／
        ￣￣￣
```

---

## このプロジェクトについて

### Matchaとの出会い

ほうじ茶は、[**Matcha**](https://www.elecode.jp/matcha) という素晴らしいプロジェクトに触発されて生まれました。

Matchaは「法律答案をコードする」ための専門言語です。法的推論を形式的に記述し、構造化された方法で表現できるツール——そのアイデアに強く惹かれました。

法律の答案を書くとき、私たちは常に同じ構造を繰り返します。
「規範を定立して、事実をあてはめて、結論を出す」——法的三段論法です。

でも、この構造は頭の中にあるだけで、明示的に書き出されることはありません。
だから、要件を一つ飛ばしてしまったり、論点の検討を忘れてしまったり。
答案を書き終わってから「あ、これ書き忘れた」と気づくことも。

プログラミングでコンパイラが「この変数は未定義です」と教えてくれるように、
「この要件はまだ検討されていません」と教えてくれる仕組みがあったら？

それがMatchaの目指すところでした。

### なぜ分岐したのか

Matchaは非常に面白いプロジェクトでしたが、OSSではありませんでした。
「こんな機能があったら便利だな」と思っても、参加する方法がなかったのです。

そして私には、もう一つの目的がありました。

**人間が使うことを主軸としない使い方——AIによる法的起案を加速させたい。**

AIによる法律業務の品質を最低限担保するためには、リンターエラー機能がどうしても必要でした。
AIが法的推論を生成したとき、「この要件が欠落しています」「この論点の検討を推奨します」と
フィードバックを返せる仕組み。それがなければ、AIの出力は構造的な品質チェックを受けられません。

そのために必要なのが **MCP（Model Context Protocol）** への対応です。

### LSPとゴーストライターの時代

CursorやGitHub Copilotの登場以降、AIを使った開発の形は大きく変わりました。

**ゴーストライター** ——AIが先読みして自動で補完候補を提案し、人間がTabで承認する。
この共同作業への移行が加速しています。

その際に必要なのは **LSP（Language Server Protocol）** です。
構文を自動解析し、エディタと連携する仕組み。VS CodeやCursorと統合できる基盤。

これがあれば、あとは自動補完用のLLMを作り、ほうじ茶のデータで学習することで、
より実務家の思考過程や処理過程を補完するエコシステムが構築できます。

だから、**MCP対応**と**LSP実装**を主眼に据えて、このプロジェクトを始めました。

### 名前の由来

元々のインスピレーション元が「Matcha」という名前だったので、
同じ日本茶つながりで「ほうじ茶（Houjicha）」と名付けました。

なんとなくほうじ茶は廉価で下町感があります。
麦茶でもよかったのですが、なんとなく麦茶はあまり法律っぽくないので……

マスコットは「**ほうじ茶さん**」。一緒に法的三段論法を学んでいきましょう！

### 参加してください！

このプロジェクトはOSSです。

- 「こんな機能がほしい」
- 「この構文はこうした方がいい」
- 「条文データベースを充実させたい」

やりたいことがある人、ぜひ参加してください！

---

## 設計思想

### コードにおけるエラー = 法的推論におけるエラー

プログラミングにおいてコンパイルエラーが「これじゃ動かない」と教えてくれるように、
ほうじ茶は「この法的推論は構造的に成立しない」と教えてくれます。

```
┌─────────────────────────────────────────────────────────┐
│  プログラミング          │  法的推論（ほうじ茶）        │
├─────────────────────────────────────────────────────────┤
│  コンパイルエラー        │  必須要件の欠落              │
│  型エラー                │  論理矛盾                    │
│  Linter警告              │  論点の検討推奨              │
│  コード補完              │  要件・規範の候補提示        │
└─────────────────────────────────────────────────────────┘
```

**形式的チェック**（要件の欠落など）→ プログラム（ほうじ茶）の仕事
**実質的判断**（論理矛盾、事実認定など）→ AI/法律家の仕事

ほうじ茶は「構造」を担当し、「内容の正しさ」は人間やAIに委ねます。

### 法学の基礎構造

Matchaの基本流れと同様、ほうじ茶も以下の構造に従います：

**法的根拠 → 法的主張 → 要件 → あてはめ → 結論**

```
法源（条文・法令等）
    ↓ 文言を分解
法的要件
    ↓ 不確定性がある場合
解釈（規範）
    ↓
事実 + 法的評価（あてはめ）
    ↓ 全要件を満たす場合
法的効果
    ↑
法的主張（訴訟物クラス）※主張≠要件
```

### 法的三段論法の担保

AIが法的推論を行う際、法的三段論法は絶対に落とせません：

```
大前提（規範）：Xという要件を満たせばYという効果が生じる
小前提（事実）：本件ではXという事実がある
結論：よってYという効果が生じる
```

ほうじ茶はこの構造を強制することで、法的推論の品質を担保します。

---

## 構文リファレンス

### 基本の記法

```houjicha
#主張^法的根拠 <= 事実:
    *要件: %定義 <= 事実@評価
>> 結論
```

### 記号と法学概念の対応

| 記号 | 法学概念 | 説明 |
|------|---------|------|
| `#` | 法的主張（請求原因/訴因） | 結論として主張したいこと |
| `^` | 法源（条文参照） | 根拠となる条文 |
| `*` | 法的要件 | 条文から導かれる構成要件 |
| `%` | 解釈（規範） | 判例・学説による解釈基準 |
| `?` | 論点（解釈が不確定） | 争いのある解釈問題 |
| `<=` | 法的評価（あてはめ） | 事実への規範の適用 |
| `>>` | 法的効果 | 要件を満たした結果 |
| `+` | 充足 | 要件を満たす |
| `!` | 不充足 | 要件を満たさない |
| `&` | AND | 複数要件を「かつ」で結合 |
| `\|` | OR | 複数要件を「または」で結合 |
| `;` | 理由 | 論理展開の理由付け |
| `∵` | 思考過程メモ | 自分用のメモ（プレビュー非表示） |

### 基本的な書き方

```
        ╭─────────────────────────────────────────╮
  📝    │  主張は # で始めるよ！                  │
        │  ^で根拠条文、<=で事実をあてはめ！      │
        ╰─────────────────────────────────────────╯
```

#### 主張（Claim）
```houjicha
#窃盗罪^刑法235条 <= 甲の行為:
    *他人の財物 <= 本件財布はAの所有
    *窃取 <= 持ち去った
    >> 窃盗罪が成立する
```

#### 要件と規範（一行で書く）
```houjicha
*窃取: %占有者の意思に反して占有を移転 <= 甲が持ち去った
```

#### 論点
```houjicha
? 不法領得の意思は必要か ~> 使用窃盗との区別 => %不法領得の意思
```

#### 名前空間（答案の区切り）
```houjicha
:: 甲の罪責
    #窃盗罪^刑法235条 <= 甲の行為

:: 乙の罪責
    #窃盗罪の共同正犯^60条・235条 <= 乙の行為
```

#### 評価（複数@）
```houjicha
*暴行脅迫 <= 乙がナイフを突きつけた@凶器使用@計画的@深夜
```

#### 理由と思考過程メモの違い
```houjicha
*他人の財物 <= 本件財布
    ; 財産犯の基本的構成要件である（→論理展開として表示される）
    ∵ ここは争いないので簡潔に（→自分用メモ、プレビュー非表示）
```

### 記号一覧

| 記号 | 名前 | 例 |
|------|------|-----|
| `#` | 主張 | `#窃盗罪^刑法235条` |
| `*` | 要件 | `*他人の財物` |
| `%` | 規範 | `%占有者の意思に反して` |
| `?` | 論点 | `? 不法領得の意思は必要か` |
| `>>` | 効果 | `>> 窃盗罪成立` |
| `<=` | あてはめ | `<= 甲が持ち去った` |
| `^` | 根拠条文 | `^刑法235条` |
| `+` | 肯定結論 | `+#窃盗罪` |
| `!` | 否定結論 | `!#窃盗罪` |
| `::` | 名前空間 | `:: 甲の罪責` |
| `@` | 評価 | `事実@評価` |
| `;` | 理由 | `; 判例の立場による` |
| `∵` | 思考過程メモ | `∵ ここは要検討` |
| `~>` | 理由（論点内） | `~> 使用窃盗との区別` |
| `=>` | 導出 | `=> %規範` |
| `( & \| )` | 複合事実 | `(A & B)` |
| `//` | コメント | `// コメント` |

---

## AIとの協働

### 目指す姿

```
1. AI: 事実を受け取る
2. AI: MCPツールで .houjicha を生成
3. ほうじ茶: エラー返す「必須要件Xが未検討」
4. AI: 修正して再生成
5. ほうじ茶: 警告返す「論点Yの検討を推奨」
6. AI: 必要性を判断してスキップ or 追加
7. ほうじ茶: OK
8. AI: 完成した法的推論を返す
```

### 役割分担

**ほうじ茶がやること**:
- 入力補助（補完、テンプレート展開）
- エラー検出（バリデーション）
- データ提供（条文DB、要件・論点の候補）

**ほうじ茶がやらないこと**:
- 契約書の解析（AIシステムの仕事）
- 法令適合性の判断（AIシステムの仕事）
- 事実認定（法律家の仕事）

### 弁護士による監督

- AIは弁護士の監督下で動く（非弁行為にならない）
- 最終判断は人間（弁護士）が行う
- ほうじ茶は構造的な品質チェックを提供

### ゴーストライティング（Tab補完）

```
%不法領得の意思 <= |
                   │
                   ▼
    ┌─────────────────────────────────┐
    │ 👻 甲は財布を自己の物として     │  ← AIゴースト提案
    │    利用処分する意思を有していた │
    └─────────────────────────────────┘
                   │
                   │ Tab
                   ▼
%不法領得の意思 <= 甲は財布を自己の物として利用処分する意思を有していた
```

AIが先読みして補完候補を提案し、人間がTabで承認する。
この共同作業を実現するために、LSPを実装しています。

---

## 法的権威充足構造（将来構想）

法学では何かを確定させるときに「それが何の権威に支えられているか」を常に考えます。
権威は固定的な階層ではなく、**通用力**（みんながこれを基準にしている度合い）によって動的に決まります。

### 暫定的な階層

```
【第1層：最高規範】
└── 憲法、条約

【第2層：法的拘束力あり（通用力が確立）】
├── 法律（国会制定法）
├── 政令・省令・条例（委任に基づく）
├── 最高裁判例（裁判所は逆らえない）
├── 通説（通用力が確立したもの）
└── 行政解釈（行政相手の訴訟では拘束力あり）

【第3層以下：通用力によって可変】
├── 高裁判例
├── 地裁判例
├── 有力説
├── 学説
└── etc.
```

### 現時点での設計方針

この構造の詳細な実装は将来のAIエコシステム設計で検討します。

理由：
- 通用力は事案ごとに調整が必要
- 誰に対して通用するかはタグで分析できる類ではない
- 思考ルールとしてAIに伝える方が適切

---

## 将来構想: RAGベースアーキテクチャ

### 基本概念：「実体はベクトル、関係だけ保持」

```
┌─────────────────────────────────────────────────────────┐
│  RAG空間（ベクトルDB）                                   │
│                                                         │
│    ● vec_001「不法領得の意思」                           │
│    ● vec_002「権利者排除意思」                           │
│    ● vec_003「甲が財布を持ち去った」                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
                    │
                    │ ベクトルID参照
                    ▼
┌─────────────────────────────────────────────────────────┐
│  構文ファイル（関係性グラフ）                             │
│                                                         │
│    # 窃盗罪                                              │
│      └─[要件]─→「窃取」                                  │
│            └─[規範]─→ % vec_005                         │
│                  └─[あてはめ]─→ vec_003                 │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### メリット

1. **概念の正規化**: 同じ意味は同じベクトルに収束
2. **検索効率**: テキスト全文ではなくベクトル類似度で検索
3. **クロスファイル**: 別ファイルの関連箇所が自動で見つかる
4. **AI連携**: ベクトル空間はLLMと相性が良い

---

## VS Code拡張の使い方

### インストール

1. `.vsix`ファイルをダウンロード
2. VS Codeで`Extensions: Install from VSIX...`を実行
3. `.houjicha`または`.hcha`ファイルを開く

### キーバインド

| キー | コマンド |
|------|---------|
| `Ctrl+Space` | 補完候補を表示 |
| `Ctrl+Shift+V` | プレビューを開く |
| `Ctrl+Shift+H` | 記号早見表を表示 |

### 機能

- **シンタックスハイライト**: 記号ごとに色分け
- **補完**: 記号入力時に候補を表示
- **エラー検出**: 構文エラー、欠落要件を警告
- **全角スペース警告**: 半角スペースへの置換を推奨
- **ホバー情報**: 記号にカーソルを合わせると説明を表示
- **アウトライン**: 論証構造をツリー表示

---

## 柔軟性の担保

### 設計原則

1. **YAMLスキーマは拡張可能に**
   - 新しい属性（権威レベル、通用力等）を後から追加可能
   - 既存のデータとの後方互換性を維持

2. **エラーレベルは設定可能に**
   - 必須/推奨の区別は設定で変更可能
   - AIエコシステムの要求に応じて調整可能

3. **MCPツールは汎用的に**
   - 特定のワークフローに縛られない設計
   - 様々なAIエージェントから利用可能

4. **法的権威の判断ロジックは外部化**
   - 言語コアには組み込まない
   - AIの思考ルールとして別途定義

---

## 動作サンプル

```
        ╭─────────────────────────────────────────╮
  ✨    │  このサンプルはちゃんと動くよ！         │
        ╰─────────────────────────────────────────╯
```

```houjicha
// 窃盗罪の検討

#窃盗罪^刑法235条 <= 甲がスーパーで商品を持ち去った行為:
    ∵ まず構成要件を順に検討していく
    *他人の財物: %他人が所有する財産的価値のある有体物 <= 本件商品はスーパー所有
    *窃取: %占有者の意思に反して占有を移転 <= 甲が商品をカバンに入れた
        ∵ いつ占有移転したかは論点になりうるが、カバン挿入時で問題ないだろう
    *不法領得の意思: %権利者排除意思と利用処分意思 <= 甲は自己の物とする意思あり
        ∵ 使用窃盗との区別も一応意識しておく
    %故意 <= 認識認容あり
    >> 甲に窃盗罪が成立する
```

---

## ファイル構成

```
houjicha/
├── src/
│   ├── language/
│   │   ├── ast.ts          # AST型定義
│   │   ├── lexer.ts        # トークナイザー
│   │   ├── parser.ts       # パーサー
│   │   └── loader.ts       # YAML ローダー
│   ├── lsp/
│   │   └── server.ts       # LSPサーバー
│   ├── mcp/
│   │   └── server.ts       # MCPサーバー
│   └── vscode-extension/
│       └── extension.ts    # VS Code拡張
├── articles/               # 条文データベース（YAML）
├── examples/               # サンプルファイル
├── docs/                   # ドキュメント
└── package.json
```

---

## 技術スタック

- **言語**: TypeScript
- **LSP**: vscode-languageserver / vscode-languageclient
- **MCP**: @modelcontextprotocol/sdk
- **パッケージング**: vsce (VS Code Extension Manager)
- **YAML**: js-yaml
- **将来**: ベクトルDB (Pinecone, Weaviate, etc.)、LLM API

---

## ロードマップ

### Phase 1: 基盤強化 ✅ 完了
- [x] 基本構文のパーサー
- [x] LSPサーバー
- [x] VS Code拡張
- [x] YAMLデータベース
- [x] 行内複合構文
- [x] 規範ネスト
- [x] 思考過程メモ（`∵`）

### Phase 2: 補完システム 🚧 進行中
- [ ] db-search モード
- [ ] candidate-cycle モード
- [ ] InlineCompletionProvider

### Phase 3: AI連携
- [ ] ai-generate モード
- [ ] Tab補完でゴースト受け入れ
- [ ] 文脈を考慮した提案

### Phase 4: RAGアーキテクチャ
- [ ] ベクトル化パイプライン
- [ ] 関係性グラフの保存形式設計
- [ ] クロスファイル参照
- [ ] 概念の自動提案

---

## クレジット

このプロジェクトは [Matcha](https://www.elecode.jp/matcha) のアイデアに触発されて生まれました。
法律答案をコードするという素晴らしい発想に感謝します。

---

> 「ほうじ茶さんと一緒に、法的三段論法をもっと楽しく！」
>
> `.houjicha` または `.hcha` ファイルで書けるよ！
> それじゃあ、よい法的三段論法ライフを！
