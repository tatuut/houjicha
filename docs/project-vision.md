# ほうじ茶（Houjicha）プロジェクト全体像

> このドキュメントは、プロジェクトの現状と将来構想をまとめたものです。

---

## 1. プロジェクト概要

### 1.1 目的
**法的三段論法を構造化し、AIによる執筆支援を実現する**

法律の答案・文書作成において：
- 論証構造を形式言語で記述
- 構造化されたデータを基にAIが提案・補完
- 再利用可能な規範・理由のデータベース構築

### 1.2 名前の由来
- 元々「Matcha」という名前があったが、別プロジェクトのため
- 「ほうじ茶（Houjicha）」として独自に発展
- マスコットは「ほうじ茶ちゃん」

---

## 2. 言語仕様

### 2.1 基本構文（実装済み）

| 記号 | 名前 | 用途 | 例 |
|------|------|------|-----|
| `#` | 主張 | 法的結論 | `#窃盗罪^刑法235条` |
| `「」` | 要件 | 構成要件 | `「他人の財物」` |
| `%` | 規範 | 解釈基準 | `%占有者の意思に反して` |
| `?` | 論点 | 問題提起 | `? 不法領得の意思は必要か` |
| `>>` | 効果 | 法的効果 | `>> 窃盗罪成立` |
| `<=` | あてはめ | 事実への適用 | `<= 甲が持ち去った` |
| `^` | 根拠条文 | 条文参照 | `^刑法235条` |
| `+` | 肯定結論 | 成立する | `+#窃盗罪` |
| `!` | 否定結論 | 成立しない | `!#窃盗罪` |
| `::` | 名前空間 | 論述の区切り | `:: 甲の罪責` |
| `( & \| )` | 複合事実 | 事実の論理結合 | `(A & B)` |
| `@` | 評価 | 事実への評価付与 | `事実@評価` |
| `=>` | 導出 | 規範の導出 | `=> %規範` |
| `as` | 定数定義 | 規範の名前付け | `%規範 as 名前` |
| `$` | 定数展開 | 定義した規範の参照 | `$名前` |
| `//` | コメント | 注釈 | `// コメント` |

### 2.2 追加予定の構文

| 記号 | 名前 | 用途 | 状態 |
|------|------|------|------|
| `∵` (または別の1文字) | 理由 | 思考過程のメモ | 設計中 |
| 行内複合 | - | `「要件」: %規範 <= 事実` | 実装予定 |
| 複数@ | - | `甲@自己 行為@移転` | 実装予定 |
| 規範ネスト | - | `%規範:` + インデント | 実装予定 |

### 2.3 構文の設計思想

```
主張 (#)
  └── 要件 (「」)
        ├── 規範 (%)
        │     └── あてはめ (<=)
        │           └── 事実 @ 評価
        └── 理由 (∵) ← 独立行、後からRAGで関連付け
```

- **構造化**: 法的三段論法の要素を明示的に分離
- **柔軟性**: 理由などの思考過程は独立行で自由に記述
- **再利用性**: `as` で定義した規範は別の場所で参照可能

---

## 3. システムアーキテクチャ

### 3.1 現在の構成

```
┌─────────────────────────────────────────────────────────┐
│  VS Code Extension                                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Language Client                                 │   │
│  └─────────────────────────────────────────────────┘   │
│                         │                               │
│                         ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │  LSP Server                                      │   │
│  │  ├── Lexer (トークン化)                          │   │
│  │  ├── Parser (AST構築)                            │   │
│  │  ├── Diagnostics (エラー検出)                    │   │
│  │  ├── Completion (補完)                           │   │
│  │  └── Article Database (YAML)                     │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 3.2 YAMLデータベース

条文ごとに要件・規範・論点を定義：

```yaml
# articles/刑法/235_窃盗.yaml
id: "刑法235条"
name: "窃盗罪"
requirements:
  - name: "他人の財物"
    description: "他人が所有する財産的価値のある有体物"
  - name: "窃取"
    norms:
      - content: "占有者の意思に反して占有を移転すること"
issues:
  - question: "不法領得の意思は必要か"
    majority: "必要説（判例）"
```

---

## 4. 将来構想: RAGベースアーキテクチャ

### 4.1 基本概念

**「実体はベクトル、関係だけ保持」**

```
┌─────────────────────────────────────────────────────────┐
│  RAG空間（ベクトルDB / プロバイダー提供）                 │
│                                                         │
│    ● vec_001「不法領得の意思」                           │
│    ● vec_002「権利者排除意思」                           │
│    ● vec_003「甲が財布を持ち去った」                      │
│    ● vec_004「使用窃盗との区別のため」                    │
│    ● vec_005「占有者の意思に反して」                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
                    │
                    │ ベクトルID参照
                    ▼
┌─────────────────────────────────────────────────────────┐
│  構文ファイル（関係性グラフ）                             │
│                                                         │
│    # 窃盗罪                                              │
│      └─[要件]─→「他人の財物」                            │
│      └─[要件]─→「窃取」                                  │
│            └─[規範]─→ % vec_005                         │
│                  └─[あてはめ]─→ vec_003                 │
│      └─[規範]─→ % vec_001                               │
│            └─[ネスト]─→ % vec_002                       │
│            └─[理由]─→ ∵ vec_004                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 二重RAG登録アーキテクチャ

RAGへの登録は **2種類の粒度** で行う：

#### 粗粒度（文脈RAG）
- **対象**: 段落以下のネスト全体
- **形式**: 記号を自然言語に置き換えた文章
- **用途**: 文脈を考慮した検索・提案

```
元の構文:
    #窃盗罪^刑法235条 <= 甲の行為:
        「窃取」: %占有者の意思に反して占有を移転 <= 甲が財布を持ち去った

        ↓ 自然言語化

文脈RAG登録:
    vec_100: 「窃盗罪（刑法235条）について甲の行為を検討する。
              窃取とは、占有者の意思に反して占有を移転することをいう。
              本件では、甲が財布を持ち去った行為がこれに該当する。」
```

#### 細粒度（要素RAG）
- **対象**: 個々の要素（規範、要件、事実など）
- **形式**: 要素のテキストそのまま
- **用途**: 厳密な関係性の管理、再利用

```
要素RAG登録:
    vec_001: 「窃取」
    vec_002: 「占有者の意思に反して占有を移転」
    vec_003: 「甲が財布を持ち去った」
```

#### 包含関係の管理

```
┌─────────────────────────────────────────────────────────┐
│  関係性グラフ                                            │
│                                                         │
│  vec_100 (文脈)                                         │
│    ├──[包含]──→ vec_001 (要素)                          │
│    ├──[包含]──→ vec_002 (要素)                          │
│    └──[包含]──→ vec_003 (要素)                          │
│                                                         │
│  vec_001 ──[規範]──→ vec_002                            │
│  vec_002 ──[あてはめ]──→ vec_003                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**メリット**:
- **文脈検索**: 「窃盗罪の論証」で検索 → vec_100 がヒット → 全体の流れが取れる
- **要素検索**: 「占有の移転」で検索 → vec_002 がヒット → ピンポイントで取れる
- **重複なし**: 包含関係がグラフにあるので、vec_100 と vec_002 が同じ内容を含んでいても「同じものの一部」と分かる
- **効率的な更新**: 要素を変更したら、包含している文脈RAGも自動で影響範囲が分かる

### 4.3 データの流れ

```
[ユーザーが書く]
      │
      ▼
┌─────────────────┐
│ %不法領得の意思  │  ← 普通にテキストで書く
└─────────────────┘
      │
      │ 自動ベクトル化
      ▼
┌─────────────────┐
│ RAG空間に保存    │  ← プロバイダーAPIでベクトル取得
│ vec_001 を取得   │
└─────────────────┘
      │
      │ 関係性を構文で記述
      ▼
┌─────────────────┐
│ ファイルには     │
│ 関係だけ保持     │  ← % [vec_001] <= [vec_003]
└─────────────────┘
```

### 4.4 提案システム（2種類）

#### 機械提案（RAG検索）
```
ユーザーが「%」を打つ
      │
      ▼
現在のコンテキスト（主張名、要件など）をベクトル化
      │
      ▼
RAG空間で類似ベクトルを検索
      │
      ▼
「この規範使いますか？」と候補を提示
```

#### AI提案（ゴーストライティング）
```
機械提案の結果
      │
      ▼
AIが文脈を理解
      │
      ▼
「こう書いたらどうですか？」と文案を生成
      │
      ▼
Tabキーで受け入れ
```

### 4.5 クロスファイル参照

同じベクトルを参照していれば、自動で繋がる：

```
file_A.houjicha:
    % vec_001「不法領得の意思」 <= ...

file_B.houjicha:
    % vec_001「不法領得の意思」 <= ...  ← 同じベクトル

                    │
                    ▼
        「この概念を使っている他の場所」
        が自動で辿れる
```

### 4.6 メリット

1. **概念の正規化**: 同じ意味は同じベクトルに収束
2. **検索効率**: テキスト全文ではなくベクトル類似度で検索
3. **クロスファイル**: 別ファイルの関連箇所が自動で見つかる
4. **拡張性**: 新しい関係性を追加しても既存データに影響なし
5. **AI連携**: ベクトル空間はLLMと相性が良い

---

## 5. 補完システム設計

### 5.1 トリガーと補完モード

| トリガー | モード | 動作 |
|----------|--------|------|
| `#` | db-search | 主張名をDBから検索 |
| `^` | db-search | 条文をDBから検索 |
| `「` | candidate-cycle | 要件候補を矢印キーでサイクル |
| `%` | candidate-cycle | 規範候補を矢印キーでサイクル |
| `?` | candidate-cycle | 論点候補を矢印キーでサイクル |
| `<=` | ai-generate | AIがあてはめ文を生成 |
| `>>` | ai-generate | AIが効果文を生成 |
| `@` | ai-generate | AIが評価を生成 |

### 5.2 Tab補完

```
%不法領得の意思 <= |
                   │
                   ▼
    ┌─────────────────────────────────┐
    │ 👻 甲は財布を自己の物として     │  ← AIゴースト提案
    │    利用処分する意思を有していた │
    └─────────────────────────────────┘
                   │
                   │ Tab
                   ▼
%不法領得の意思 <= 甲は財布を自己の物として利用処分する意思を有していた
```

---

## 6. 理由記号（`∵`）の設計

### 6.1 コンセプト

- **独立行として記述**: 直前の要素に厳密に紐付けない
- **後からRAGで関連付け**: 書いた時点では「浮いている」
- **タグ的な関連**: ファイル全体、近くの `%` 行、キーワードなどと緩く関連

### 6.2 書き方

```matcha
%不法領得の意思 <= あてはめ
∵ 財産犯と使用窃盗を区別する必要がある
∵ 毀棄罪との区別も必要
```

### 6.3 データ構造

```
∵ 行
  ├── [関連: ファイル全体]
  ├── [関連: 直前の % 行]
  ├── [関連: キーワード「不法領得の意思」]
  └── [ベクトル: vec_XXX]
```

- 厳密な論理関係ではなく「関連性」として保持
- 後からRAG検索で「この規範に関連する理由」として引っ張れる

---

## 7. ロードマップ

### Phase 1: 基盤強化（現在）
- [x] 基本構文のパーサー
- [x] LSPサーバー
- [x] VS Code拡張
- [x] YAMLデータベース
- [ ] 行内複合構文の対応
- [ ] 規範ネストの対応
- [ ] 理由記号（`∵`）の追加

### Phase 2: 補完システム
- [ ] db-search モード
- [ ] candidate-cycle モード
- [ ] InlineCompletionProvider

### Phase 3: AI連携
- [ ] ai-generate モード
- [ ] Tab補完でゴースト受け入れ
- [ ] 文脈を考慮した提案

### Phase 4: RAGアーキテクチャ
- [ ] ベクトル化パイプライン
- [ ] 関係性グラフの保存形式設計
- [ ] クロスファイル参照
- [ ] 概念の自動提案

---

## 8. ファイル構成

```
macha/
├── src/
│   ├── language/
│   │   ├── ast.ts          # AST型定義
│   │   ├── lexer.ts        # トークナイザー
│   │   ├── parser.ts       # パーサー
│   │   ├── schema.ts       # YAML スキーマ
│   │   └── loader.ts       # YAML ローダー
│   ├── lsp/
│   │   └── server.ts       # LSPサーバー
│   └── vscode-extension/
│       └── extension.ts    # VS Code拡張
├── articles/               # 条文データベース（YAML）
│   ├── 刑法/
│   │   └── 235_窃盗.yaml
│   └── 民法/
│       └── 94_虚偽表示.yaml
├── examples/               # サンプルファイル
├── docs/
│   ├── syntax-guide.md     # 構文ガイド
│   └── project-vision.md   # このファイル
└── package.json
```

---

## 9. 技術スタック

- **言語**: TypeScript
- **LSP**: vscode-languageserver / vscode-languageclient
- **パッケージング**: vsce (VS Code Extension Manager)
- **YAML**: js-yaml
- **将来**: ベクトルDB (Pinecone, Weaviate, etc.)、LLM API

---

> 「ほうじ茶ちゃんと一緒に、法的三段論法をもっと楽しく！」
